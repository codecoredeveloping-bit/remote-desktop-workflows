name: macOS VNC - CLOUDFLARE
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    timeout-minutes: 9999

    steps:
      - name: Install Cloudflared
        run: |
          brew install cloudflare/cloudflare/cloudflared
          echo "‚úÖ Cloudflared Installed!"

      - name: Configure VNC & Password
        run: |
          # ŒüœÅŒπœÉŒºœåœÇ œÑŒøœÖ password Œ±œÄŒµœÖŒ∏ŒµŒØŒ±œÇ Œ≥ŒπŒ± œÑŒø VNC (Legacy mode)
          # ŒßœÅŒ∑œÉŒπŒºŒøœÄŒøŒπŒøœçŒºŒµ œÑŒø 'sudo' Œ≥ŒπŒ± ŒΩŒ± Œ±œÄŒøœÜœçŒ≥ŒøœÖŒºŒµ œÑŒø œÉœÜŒ¨ŒªŒºŒ± Œ¨Œ¥ŒµŒπŒ±œÇ
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -clientopts -setvnclegacy -vnclegacy yes \
            -setvncpw -vncpw P@ssw0rd123! \
            -restart -agent -privs -all

          # ŒïŒΩŒµœÅŒ≥ŒøœÄŒøŒØŒ∑œÉŒ∑ Œ≥ŒπŒ± œåŒªŒøœÖœÇ œÑŒøœÖœÇ œáœÅŒÆœÉœÑŒµœÇ
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -configure -allowAccessFor -allUsers -privs -all

          echo "‚úÖ VNC Configured with Password!"

      - name: Start Cloudflare Tunnel
        run: |
          echo "============================================"
          echo "üöÄ macOS VNC - CLOUDFLARE TUNNEL"
          echo "============================================"
          cloudflared tunnel --url tcp://5900 > tunnel.log 2>&1 &
          sleep 30
          cat tunnel.log | grep -o 'https://[^[:space:]]*trycloudflare.com' || echo "Check logs for tunnel URL"
          echo "‚úÖ TUNNEL STARTED!"

      - name: Keep Session Alive
        run: |
          echo "‚è≥ Session Active - Keeping alive..."
          while true; do
            sleep 60
            echo "‚úì Active - $(date '+%H:%M:%S')"
          done
