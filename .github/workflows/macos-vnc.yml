name: macOS VNC - NGROK
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Install Ngrok
        run: brew install ngrok/ngrok/ngrok

      - name: Configure VNC
        run: |
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -clientopts -setvnclegacy -vnclegacy yes \
            -setvncpw -vncpw P@ssw0rd123! \
            -restart -agent -privs -all
          
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -configure -users runner -access -on -privs -all

      - name: Start Ngrok Tunnel
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          ngrok config add-authtoken $NGROK_AUTH_TOKEN
          ngrok tcp 5900 --log=stdout > ngrok.log &
          sleep 10
          curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url'

      - name: Keep Alive
        run: |
          echo "‚è≥ Connected! Copy the address above (e.g., tcp://0.tcp.ngrok.io:12345)"
          while true; do sleep 60; done
